const app=document.getElementById("app");window.pageCleanup=null;window.pageTimers=[];function loadingElement(){const loadingElement=document.createElement("div");loadingElement.className="text-center";const ldinner=document.createElement("div");ldinner.className="spinner-border";ldinner.setAttribute("role","status");const srOnly=document.createElement("span");srOnly.className="visually-hidden";srOnly.textContent="åŠ è½½ä¸­...";ldinner.appendChild(srOnly);loadingElement.appendChild(ldinner);return loadingElement.outerHTML}function toggleTheme(){const currentTheme=document.documentElement.getAttribute("data-theme")||"light";let newTheme;const themeToggle=document.getElementById("theme-toggle");const themeIcon=themeToggle?.querySelector(".theme-icon");if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","dark");newTheme="dark";if(themeIcon)themeIcon.textContent="â˜€ï¸"}else{document.documentElement.setAttribute("data-theme","light");newTheme="light";if(themeIcon)themeIcon.textContent="ğŸŒ™"}localStorage.setItem("theme",newTheme)}function initThemeToggle(){const themeToggle=document.getElementById("theme-toggle");const themeIcon=themeToggle?.querySelector(".theme-icon");const currentTheme=localStorage.getItem("theme")||"dark";if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","light");if(themeIcon)themeIcon.textContent="ğŸŒ™"}else{document.documentElement.setAttribute("data-theme","dark");if(themeIcon)themeIcon.textContent="â˜€ï¸"}}function initTheme(){const currentTheme=localStorage.getItem("theme")||"dark";if(currentTheme==="light"){document.documentElement.setAttribute("data-theme","light")}else{document.documentElement.setAttribute("data-theme","dark")}}document.addEventListener("menuLoaded",initThemeToggle);function jumpTo(url,loadContainerId="app"){if(url.startsWith("/")){if(url==="/")url="/home";loadPage(loadContainerId,url)}else{window.open(url,"_blank")}}const loading=loadingElement();let navHtml=``;let menuHtml=``;const defaultMethods={toggleTheme:toggleTheme};initTheme();document.addEventListener("DOMContentLoaded",()=>{if(window.location.pathname==="/")window.location.pathname="/home";loadPage()},false);window.addEventListener("popstate",function(event){loadPage()});async function loadScriptFromSrc(pageName){try{const pageModule=await import(`./js/${pageName}`);let initFuncLst=[];if(typeof pageModule.init==="function"){initFuncLst.push(pageModule.init)}else{console.warn(`é¡µé¢ ${pageName} ç¼ºå°‘ init å‡½æ•°`)}return{methods:pageModule.methods||{},initFuncLst:initFuncLst}}catch(error){console.error(`åŠ è½½é¡µé¢ ${pageName} å¤±è´¥:`,error);return{}}}function loadScript(scriptContent){return new Promise((resolve,reject)=>{const script=document.createElement("script");script.innerText=scriptContent;script.async=true;script.setAttribute("data-loaded-from",window.location.pathname);script.onload=()=>resolve(script);script.onerror=()=>reject(new Error(`Failed to load script: ${scriptContent}`));document.head.appendChild(script)})}function loadStyles(href){return new Promise((resolve,reject)=>{if(document.querySelector(`link[href="${href}"]`)){resolve();return}const link=document.createElement("link");link.rel="stylesheet";link.href=href;link.type="text/css";link.onload=()=>{resolve(link)};link.setAttribute("data-loaded-from",window.location.pathname);link.onerror=()=>reject(new Error(`Failed to load CSS: ${href}`));document.head.appendChild(link)})}async function clearOldPage(){window.dispatchEvent(new Event("pageUnload"));window.__pageCleanup?.();if(Array.isArray(window.pageTimers)){window.pageTimers.forEach(timerId=>{clearTimeout(timerId);clearInterval(timerId)})}else{clearTimeout(window.pageTimers);clearInterval(window.pageTimers)}window.pageCleanup=null;window.pageTimers=[];document.querySelectorAll("link").forEach(link=>{if(link.getAttribute("data-loaded-from")&&link.getAttribute("data-loaded-from")!==window.location.pathname){link.remove()}});document.querySelectorAll("script").forEach(script=>{if(script.getAttribute("data-loaded-from")&&script.getAttribute("data-loaded-from")!==window.location.pathname){script.remove()}});document.body.style.overflow="";document.body.style.height="";document.documentElement.style.height=""}async function loadPage(loadContainerId="app",url=window.location.pathname){const oldPath=window.location.pathname;console.log("oldPath:",oldPath);window.history.pushState({path:url},"",url);const container=document.getElementById(loadContainerId);if(!container){console.error(`å®¹å™¨ ${loadContainerId} ä¸å­˜åœ¨`);return}const path=window.location.pathname;container.innerHTML=loading;try{const response=await fetch(`/api/pages${path}`,{method:"POST"});const data=await processResponse(response);if(data.config.loadData){switch(data.config.loadData.method){case"derive":const superU=data.config.loadData.super;if(oldPath.startsWith(superU)&&oldPath!==path){break}else{await loadPage("app",superU);await loadPage(data.config.loadData.deriveContainer,path);return}break;default:break}}console.log(`${path} data:`,data);var methodsMap=defaultMethods;let initFuncLst=[];if(data.config.scripts){const methodsPromises=data.config.scripts.map(scriptSrc=>loadScriptFromSrc(scriptSrc));const results=await Promise.all(methodsPromises);const methodsArray=results.map(r=>r.methods);initFuncLst=results.flatMap(r=>r.initFuncLst);methodsArray.forEach(_methods=>{Object.assign(methodsMap,_methods)})}if(data.config.styles){const stylesPromises=data.config.styles.map(cssFilename=>loadStyles(`/css/${cssFilename}`));await Promise.all(stylesPromises)}const _data=renderHtml(data.page);let config=_data.config;config.nav=data.config.nav||{};config.menu=data.config.menu||{};console.log("htmlScript:",_data.scripts);console.log("rederConfig:",config);if(loadContainerId==="app")await clearOldPage();if(_data.scripts){_data.scripts.forEach(script=>loadScript(script))}await loadNavigation(config);renderPage(_data.html,data.config,methodsMap=methodsMap,loadContainerId);window.dispatchEvent(new Event("pageLoaded"));initFuncLst?.forEach(initFunc=>initFunc())}catch(error){console.error("åŠ è½½é¡µé¢å¤±è´¥:",error)}}function renderHtml(html){let config={};const scripts=[...html.matchAll(/<script>(.*?)<\/script>/gs)].map(scriptMatch=>scriptMatch[1].replace(/\n/g,""));html=html.replace(/<script>(.*?)<\/script>/gs,"");const configs=html.matchAll(/\{(\w+)\}(.*?)\{\/\1\}/gs);html=html.replace(/\{(\w+)\}(.*?)\{\/\1\}/gs,"");configs.forEach(configMatch=>{const configName=configMatch[1];const configContent=configMatch[2];config[configName]=configContent});const _json=html.match(/\{json\}(.*?)\{\/json\}/s);html=html.replace(/\{json\}(.*?)\{\/json\}/s,"");_json?.forEach(jsonMatch=>{try{const json=JSON.parse(jsonMatch[1]);Object.assign(config,json)}catch(error){console.error("JSON è§£æé”™è¯¯:",error)}});return{html:html,config:config,scripts:scripts}}function renderPage(pageHtml,config,methodsMap={},container="app"){const containerElement=document.getElementById(container);if(!containerElement){console.error(`å®¹å™¨ ${container} ä¸å­˜åœ¨`);return}containerElement.innerHTML=pageHtml;if(config?.title)document.title=config.title;document.querySelectorAll("*").forEach(element=>{Array.from(element.attributes).forEach(attr=>{if(attr.name.startsWith("data-on-")){const fullEventType=attr.name.substring(8).toLowerCase();const methodName=attr.value.trim().replace(/\([^)]*\)/g,"").replace(";","");if(!fullEventType||!methodName)return;const handler=methodsMap[methodName];if(typeof handler==="function"){const paramAttrName=`data-${fullEventType}-params`;let params=[];let hasEvent=false;const paramsStr=element.getAttribute(paramAttrName);if(paramsStr){try{params=JSON.parse(paramsStr)}catch(e){console.warn(`å‚æ•°è§£æå¤±è´¥ for ${methodName} (${paramAttrName}):`,paramsStr,e);params=[]}}element.addEventListener(fullEventType,e=>{const finalParams=[];for(let i=0;i<params.length;i++){let paramValue=params[i];if(paramValue==="event")hasEvent=true;if(typeof paramValue==="string"&&paramValue.startsWith("this.")){try{const pathParts=paramValue.replace("this.","").split(".");let currentValue=e.target;for(const part of pathParts){if(currentValue==null){console.warn(`æ— æ³•è§£æè·¯å¾„ "${paramValue}"ï¼Œ${pathParts.slice(0,pathParts.indexOf(part)).join(".")} ä¸º null æˆ– undefined`);currentValue=undefined;break}currentValue=currentValue[part]}finalParams.push(currentValue)}catch(error){console.error(`è§£æè·¯å¾„ "${paramValue}" æ—¶å‡ºé”™:`,error);finalParams.push(undefined)}}else{finalParams.push(paramValue)}}if(hasEvent)handler(e,...finalParams);else handler(...finalParams)})}else{console.warn(`æ‰¾ä¸åˆ°æ–¹æ³•: ${methodName}`,methodsMap)}}})});const as=document.querySelectorAll("a:not([data-bound])");as.forEach(a=>{a.setAttribute("data-bound","true");let loadContainerId="app";switch(a.getAttribute("data-load")){case"derive":loadContainerId=a.closest("[data-derive-container]")?.getAttribute("id")||"app";break}a.addEventListener("click",e=>{e.preventDefault();jumpTo(a.getAttribute("href"),loadContainerId)})})}async function loadNavigation(config={}){try{if(!navHtml){const navResponse=await fetch("/api/navigation",{method:"POST"});const navData=await navResponse.json();navHtml=navData.data.nav;menuHtml=navData.data.menu}const{nav,menu,...defaultConfig}=config;document.getElementById("nav").innerHTML=renderTemplate(navHtml,Object.assign(defaultConfig,config.nav||{}));document.getElementById("menu").innerHTML=renderTemplate(menuHtml,Object.assign(defaultConfig,config.menu||{}));document.dispatchEvent(new Event("menuLoaded"))}catch(error){console.error("åŠ è½½å¯¼èˆªæ å¤±è´¥:",error)}}function renderTemplate(content,data={}){content=content.replace(/\{([^}]+)\}([\s\S]*?)\{\/\1\}/g,(match,key,innerContent)=>{return data[key]?innerContent:""});content=content.replace(/\{([^}]+)\}/g,(match,key)=>{return data[key]!==undefined?data[key]:""});return content}async function processResponse(response){const data=await response.json();if(!data.success){console.error("APIè¿”å›é”™è¯¯:",data.error||"æœªçŸ¥é”™è¯¯");if(data.data?.page){return data.data}else{return{page:`<div class="alert alert-danger" role="alert">å‡ºç°é—®é¢˜ï¼Œ è¯·ç¨åå†è¯•</div>`}}}return data.data}window.jumpTo=jumpTo;window.loadPage=loadPage;